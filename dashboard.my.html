<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agency Control Node | Z Snappy Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; color: #0f172a; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid white; }
        .hidden-section { display: none; }
        .scroll-custom::-webkit-scrollbar { width: 4px; }
        .scroll-custom::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .card-glow:hover { box-shadow: 0 20px 40px -10px rgba(14, 165, 233, 0.1); }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #0ea5e9; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen pb-20">

    <div id="admin-ui">
        <!-- Top Navigation -->
        <nav class="p-8 max-w-7xl mx-auto flex justify-between items-center border-b border-slate-200 mb-8 bg-white/50 backdrop-blur-md">
            <div class="flex items-center gap-3">
                <span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
                <h2 class="font-black uppercase tracking-[0.3em] text-slate-400 text-[10px] italic">Agency Command Node v6.0</h2>
            </div>
            <div class="flex items-center gap-6">
                <div id="connection-status" class="flex items-center gap-2">
                    <div class="loading-spinner"></div>
                    <span id="auth-status" class="text-[10px] font-black text-amber-600 uppercase tracking-widest">Establishing Handshake...</span>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- LHS: Agency Controllers -->
            <div class="lg:col-span-4 space-y-6">
                <!-- ðŸ“¢ Broadcast Engine -->
                <div class="glass p-8 rounded-[2.5rem] border-l-8 border-purple-500 shadow-xl card-glow transition-all">
                    <h3 class="font-black text-[10px] text-slate-400 uppercase tracking-widest mb-6 border-b pb-4 italic">Global Signal Broadcast</h3>
                    <textarea id="bc-msg" class="w-full p-4 bg-white border border-slate-100 rounded-2xl text-xs mb-4 outline-none shadow-inner font-medium" rows="3" placeholder="Push emergency message to all creator nodes..."></textarea>
                    <div class="flex gap-3">
                        <button id="btn-broadcast-push" class="flex-grow bg-purple-600 text-white py-3 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-purple-700 shadow-lg">Push Live Signal</button>
                        <button id="btn-broadcast-kill" class="bg-slate-200 text-slate-600 px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">Kill</button>
                    </div>
                </div>

                <!-- ðŸ”— Resource Engine -->
                <div class="glass p-8 rounded-[2.5rem] border-l-8 border-sky-500 shadow-xl card-glow transition-all">
                    <h3 class="font-black text-[10px] text-slate-400 uppercase tracking-widest mb-6 border-b pb-4 italic">Resource Synchronizer</h3>
                    <div class="space-y-4 mb-8">
                        <div>
                            <label class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Master Meet Link</label>
                            <input id="meet-url" type="text" class="w-full p-3 border-b text-xs outline-none bg-transparent font-bold text-sky-600" placeholder="https://meet.google.com/xxx">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Tool Label</label>
                                <input id="tool-lab" type="text" class="w-full p-2 border-b text-xs outline-none bg-transparent" placeholder="e.g. ChatGPT">
                            </div>
                            <div>
                                <label class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Secure URL</label>
                                <input id="tool-lnk" type="text" class="w-full p-2 border-b text-xs outline-none bg-transparent" placeholder="https://">
                            </div>
                        </div>
                    </div>
                    <button id="btn-sync-resources" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-[0.3em] hover:bg-sky-600 shadow-xl transition-all">Synchronize Nodes</button>
                </div>

                <!-- ðŸ“ Task Matrix -->
                <div class="glass p-8 rounded-[2.5rem] border-l-8 border-orange-500 shadow-xl card-glow transition-all">
                    <h3 class="font-black text-[10px] text-slate-400 uppercase tracking-widest mb-6 border-b pb-4 italic">Mission Deployment</h3>
                    <div class="flex gap-3 mb-6">
                        <input id="tsk-txt" type="text" class="flex-grow p-3 bg-white border border-slate-100 rounded-xl text-xs outline-none shadow-inner" placeholder="Deploy new mission...">
                        <button id="btn-add-task" class="bg-orange-500 text-white px-5 rounded-xl font-black text-xl hover:bg-orange-600 shadow-lg">+</button>
                    </div>
                    <div id="tsk-lst" class="space-y-3 max-h-48 overflow-y-auto scroll-custom pr-2"></div>
                </div>
            </div>

            <!-- RHS: Monitoring & Analytics -->
            <div class="lg:col-span-8 space-y-8">
                <!-- Agency Metrics Row -->
                <div class="grid grid-cols-2 gap-6">
                    <div class="glass p-8 rounded-[2.5rem] shadow-lg border-b-8 border-slate-900">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Creator Base</p>
                        <h2 id="st-count" class="text-6xl font-black mt-2 leading-none">0</h2>
                    </div>
                    <div class="glass p-8 rounded-[2.5rem] shadow-lg border-b-8 border-green-600">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Node Revenue</p>
                        <h2 id="st-rev" class="text-6xl font-black mt-2 text-green-600 leading-none">â‚¹0</h2>
                    </div>
                </div>

                <!-- Main CRM Table -->
                <div class="glass rounded-[3rem] overflow-hidden shadow-2xl border border-white">
                    <div class="p-8 border-b bg-white/60 flex justify-between items-center">
                        <h3 class="font-black uppercase tracking-[0.3em] text-[10px] text-slate-400 italic">Core Database Monitor</h3>
                        <span class="text-[8px] bg-sky-100 text-sky-600 px-4 py-1.5 rounded-full font-black uppercase">Live Cloud Sync</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-slate-50 text-slate-400 font-black uppercase tracking-tighter text-[9px]">
                                <tr>
                                    <th class="p-6">Identity</th>
                                    <th class="p-6">Origin</th>
                                    <th class="p-6">Node ID</th>
                                    <th class="p-6">Contact Node</th>
                                    <th class="p-6">Control</th>
                                </tr>
                            </thead>
                            <tbody id="std-table"></tbody>
                        </table>
                    </div>
                    <div id="table-loader" class="p-20 text-center text-slate-400 font-black text-[10px] uppercase tracking-[0.4em] animate-pulse">Syncing Cloud Node Registry...</div>
                </div>

                <!-- Live Chat Activity Hub -->
                <div class="glass p-8 rounded-[3rem] shadow-xl">
                    <h3 class="font-black text-[10px] text-slate-400 uppercase mb-6 tracking-widest border-b pb-4 italic">Elite Circle Activity Monitor</h3>
                    <div id="chat-mon" class="h-64 overflow-y-auto scroll-custom p-6 bg-slate-50/50 rounded-[2rem] space-y-4 border border-slate-100 shadow-inner"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, addDoc, deleteDoc, getDoc, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Environment Configurations
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'zsnapypro-d9d22';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAzoGp2rt4CB9e5yazdlK-0G28Dp7TbXtQ",
            authDomain: "zsnapypro-d9d22.firebaseapp.com",
            projectId: "zsnapypro-d9d22",
            storageBucket: "zsnapypro-d9d22.firebasestorage.app",
            messagingSenderId: "614389089654",
            appId: "1:614389089654:web:b4e8d502a8c0e996146657"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null;
        let unsubscribeFns = [];

        // Path Generators (Ensures Rule 1 compliance)
        const getPublicCollection = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);
        const getPublicDoc = (col, id) => doc(db, 'artifacts', appId, 'public', 'data', col, id);

        // Core Authentication (Rule 3)
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Master Node Access Error:", error);
                document.getElementById('auth-status').innerText = "Access Denied";
                document.getElementById('connection-status').innerHTML = `<span class="w-3 h-3 bg-red-500 rounded-full"></span>`;
            }
        }

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (u) {
                document.getElementById('auth-status').innerText = "Master Sync Active";
                document.getElementById('connection-status').innerHTML = `<span class="w-3 h-3 bg-green-500 rounded-full animate-ping"></span>`;
                startEngine();
            } else {
                unsubscribeAll();
            }
        });

        function unsubscribeAll() {
            unsubscribeFns.forEach(unsub => unsub());
            unsubscribeFns = [];
        }

        function startEngine() {
            if (!user) return;
            unsubscribeAll();

            // 1. CRM SYNC: Fetch all students from the public artifacts path
            const registrationsUnsub = onSnapshot(getPublicCollection('registrations'), (snapshot) => {
                const table = document.getElementById('std-table'); 
                const loader = document.getElementById('table-loader');
                if(loader) loader.style.display = 'none';
                table.innerHTML = "";
                
                document.getElementById('st-count').innerText = snapshot.size;
                document.getElementById('st-rev').innerText = `â‚¹${(snapshot.size * 999).toLocaleString()}`;
                
                snapshot.forEach(dDoc => { 
                    const d = dDoc.data(); 
                    table.innerHTML += `
                        <tr class="border-b hover:bg-white/40 transition-all group">
                            <td class="p-6">
                                <b class="text-slate-900">${d.name || 'Anonymous Creator'}</b><br>
                                <span class="text-[8px] uppercase text-slate-400 font-black tracking-widest">${d.status || 'UNASSIGNED'}</span>
                            </td>
                            <td class="p-6">
                                <span class="text-[10px] font-black uppercase text-slate-500 bg-slate-100 px-2 py-0.5 rounded">${d.city || 'GLOBAL'}</span>
                            </td>
                            <td class="p-6">
                                <span class="font-mono font-black text-sky-600 bg-sky-50 px-3 py-1 rounded-lg border border-sky-100">${d.registrationID || 'SYNCING...'}</span>
                            </td>
                            <td class="p-6">
                                <div class="font-bold text-slate-800">${d.phone || 'N/A'}</div>
                                <div class="text-[9px] text-slate-400 font-medium">${d.email || 'N/A'}</div>
                            </td>
                            <td class="p-6">
                                <button class="btn-delete-node text-slate-300 hover:text-red-500 transition-colors" data-id="${dDoc.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </td>
                        </tr>`; 
                });

                // Attach button listeners after HTML generation
                document.querySelectorAll('.btn-delete-node').forEach(btn => {
                    btn.onclick = () => window.delDoc('registrations', btn.getAttribute('data-id'));
                });
            }, (err) => console.error("Database Node Error:", err));
            unsubscribeFns.push(registrationsUnsub);

            // 2. MEETING ENGINE SYNC
            const meetUnsub = onSnapshot(getPublicDoc('config', 'meeting'), (d) => { 
                if(d.exists()) document.getElementById('meet-url').value = d.data().link; 
            }, (err) => console.error("Resource Node Error:", err));
            unsubscribeFns.push(meetUnsub);
            
            // 3. COMMUNITY HUB MONITOR
            const chatUnsub = onSnapshot(query(getPublicCollection('chat'), orderBy('timestamp', 'desc'), limit(50)), (snapshot) => {
                const monitor = document.getElementById('chat-mon'); monitor.innerHTML = "";
                snapshot.forEach(dDoc => { 
                    const d = dDoc.data(); 
                    monitor.innerHTML += `
                        <div class="text-[10px] border-b border-slate-100 pb-3 transition-all hover:bg-white/50 p-2 rounded-lg">
                            <b class="text-sky-600 uppercase tracking-widest text-[8px]">${d.name || 'External Node'}:</b> 
                            <span class="text-slate-600 font-medium leading-relaxed block mt-1">${d.text || ''}</span>
                        </div>`; 
                });
            }, (err) => console.error("Communication Node Error:", err));
            unsubscribeFns.push(chatUnsub);

            // 4. MISSION MATRIX SYNC
            const tasksUnsub = onSnapshot(query(getPublicCollection('tasks'), orderBy('timestamp', 'asc')), (snapshot) => {
                const list = document.getElementById('tsk-lst'); list.innerHTML = "";
                snapshot.forEach(dDoc => { 
                    const d = dDoc.data();
                    list.innerHTML += `
                        <div class="flex justify-between items-center bg-white p-4 rounded-2xl text-[10px] border border-slate-100 font-black uppercase tracking-widest group shadow-sm transition-all hover:shadow-md">
                            <span class="text-slate-700">${d.text || 'Untitled Mission'}</span>
                            <button class="btn-delete-task text-slate-200 hover:text-red-400 transition-all" data-id="${dDoc.id}">âœ•</button>
                        </div>`; 
                });
                document.querySelectorAll('.btn-delete-task').forEach(btn => {
                    btn.onclick = () => window.delDoc('tasks', btn.getAttribute('data-id'));
                });
            }, (err) => console.error("Task Node Error:", err));
            unsubscribeFns.push(tasksUnsub);
        }

        // --- MASTER ACTIONS ---
        window.setBroadcast = async (status) => { 
            if (!user) return;
            const m = document.getElementById('bc-msg').value; 
            try {
                await setDoc(getPublicDoc('config', 'broadcast'), { 
                    message: m, 
                    active: status, 
                    timestamp: serverTimestamp() 
                }); 
                Swal.fire({ title: status ? 'SIGNAL LIVE' : 'SIGNAL KILLED', icon: 'success', confirmButtonColor: '#0f172a' }); 
            } catch(e) { console.error(e); }
        };

        window.updateResources = async () => {
            if (!user) return;
            const m = document.getElementById('meet-url').value; 
            const lab = document.getElementById('tool-lab').value; 
            const lnk = document.getElementById('tool-lnk').value;
            
            try {
                if(m) await setDoc(getPublicDoc('config', 'meeting'), { link: m });
                
                if(lab && lnk) { 
                    const dSnap = await getDoc(getPublicDoc('config', 'tools')); 
                    let links = dSnap.exists() && dSnap.data().links ? dSnap.data().links : []; 
                    links.push({ label: lab, url: lnk }); 
                    await setDoc(getPublicDoc('config', 'tools'), { links: links }); 
                    document.getElementById('tool-lab').value = "";
                    document.getElementById('tool-lnk').value = "";
                }
                Swal.fire({ title: 'NODES SYNCHRONIZED', icon: 'success', confirmButtonColor: '#0f172a' });
            } catch(e) { console.error(e); }
        };

        window.addTask = async () => { 
            if (!user) return;
            const t = document.getElementById('tsk-txt').value; 
            if(!t) return; 
            try {
                await addDoc(getPublicCollection('tasks'), { text: t, timestamp: serverTimestamp() }); 
                document.getElementById('tsk-txt').value = ""; 
            } catch(e) { console.error(e); }
        };

        window.delDoc = async (c, i) => { 
            if (!user) return;
            const res = await Swal.fire({ title: 'TERMINATE DATA NODE?', text: 'This action is irreversible.', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444' });
            if(res.isConfirmed) {
                try { await deleteDoc(getPublicDoc(c, i)); } catch(e) { console.error(e); }
            }
        };

        // Static Event Listeners
        document.getElementById('btn-broadcast-push').onclick = () => window.setBroadcast(true);
        document.getElementById('btn-broadcast-kill').onclick = () => window.setBroadcast(false);
        document.getElementById('btn-sync-resources').onclick = () => window.updateResources();
        document.getElementById('btn-add-task').onclick = () => window.addTask();

        // Initialize Authentication
        initAuth();
    </script>
</body>
</html>
